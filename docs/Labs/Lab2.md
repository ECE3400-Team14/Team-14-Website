#  Lab 2: Analog Circuitry and FFT’s

**Purpose:**

**Team Assignment:** David and Greg worked on audio while Andrew and Michael worked on IR.

## Audio Team:

2 points: Correct FFT analysis for audio

2 points: Working amplifier (or active filter) circuit for audio

2 points: Distinguish a 660Hz tone from background noise (talking/music)

## IR Team:

For our IR circuit, we started with the circuit that only consists of the phototransistor and a 1.8kΩ resistor, as provided in the lab handout:

<img src="https://cei-lab.github.io/ece3400-2018/images/lab2_phototransistor_schem.png"/>

And it looks like this on the breadboard:

<img src="https://user-images.githubusercontent.com/42748229/46548398-fa06c080-c89c-11e8-80ef-c81fa1885d85.png" width="720" height="540"/>

We started testing this circuit to determine if we actually need an amplifier or an active filter. First, we connect the oscilloscope to see if the circuit works, and it worked like a charm. Here's the waveform detected by the oscilloscope from the IR hat that emits a 6.08kHz IR signal. As we can see, the frequency we pick up is not a perfect 6.08kHz. Instead, it is about 6.47kHz.

<img src="https://user-images.githubusercontent.com/42748229/46548656-b2346900-c89d-11e8-9019-e88dd62f9795.jpeg" width="720" height="540"/>

After seeing the result, we were satisfied with the strength of the signal as this circuit actually acts as an amplifier. The current generated by the light affects the base region and this is amplified by the current gain of the transistor in the normal way. We also decided that the filtering can be done digitally as it would be more effective.

By modifying the sample code given by the FFT library and plotting the output, we can clearly distinguish the robot signal and the decoy signal. But first, we had to make a minor and yet important change to our code. In the sample code, ADCSRA was set up to be 0xe5, where the last last digit corresponds to the prescale factor as shown in the table below.

<img src="https://user-images.githubusercontent.com/42748229/46558523-60024080-c8bb-11e8-8624-8f1513b950d4.png"/>

The theoretical sampling frequency is calculate as follow. The arduino ADC clock runs at 16MHz. If the prescale factor is 64, the clock then runs at 16/64 = 0.25MHz. Each ADC conversion takes 13 cycles, which means the theoretical sampling frequency is 0.25MHz/13 = 19.2kHz. In order to eliminate aliasing for our 18kHz signal, the sampling rate needs to be at least 36kHz, which means a prescale factor of 32 should suffice. However, since the calculation is theoretical, we set the prescale factor to 16 just to be safe. This way, we absolutely would not confuse the 18kHz signal with the 6kHz signal. With a sampling frequency of 76.8kHz and 128 bins, the 6kHz signal, which is actually 6.47kHz, should have a peak at bin 21, as 6.47kHz is between 76.8/2/128\*21 = 6.3kHz and 76.8/2/128\*22 = 6.6kHz. Similarly, the 18kHz decoy signal should have a peak near bin 62. As we plot the matrix obtained through FFT, we see exactly that.

<img src="https://user-images.githubusercontent.com/42748229/46559383-3565b700-c8be-11e8-998c-e61b1a442d93.png"/>
<img src="https://user-images.githubusercontent.com/42748229/46559389-3bf42e80-c8be-11e8-90a9-d87d710551df.png"/>

By setting an appropriate threshold for bin 21, we can detect the IR hat from about 50cm away and ignore the decoy. We connected an external LED to indicate such detection.

```cpp
if (fft_log_out[21] > 60) digitalWrite(13, HIGH);
else digitalWrite(13, LOW);
```

[insert videos of IR hat and decoy]

2 points: Correct FFT analysis for IR

2 points: Working amplifier (or active filter) circuit for IR

2 points: Distinguish a 6.08kHz IR signal from an IR signal at 18kHz

## Integrated System:

3 points: Demonstration of a single system with nicely merged code that can do both IR and audio
